name: Send Newsletter via Buttondown

on:
  workflow_dispatch:

jobs:
  send-newsletter:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Find newsletter file
        id: find-newsletter
        run: |
          # Find the latest newsletter by filename (YYYY-MM-DD format, excluding _index.md)
          NEWSLETTER_PATH=$(ls content/en/newsletters/*.md | grep -v "_index.md" | sort -r | head -1)
          
          if [ ! -f "$NEWSLETTER_PATH" ]; then
            echo "Error: No newsletter found"
            exit 1
          fi
          
          # Extract the date from frontmatter and verify it's within the last 7 days
          FILE_DATE=$(grep -m1 "^date:" "$NEWSLETTER_PATH" | sed 's/date:[[:space:]]*//' | tr -d "'" | tr -d '"')
          FILE_TIMESTAMP=$(date -d "$FILE_DATE" +%s 2>/dev/null || date -j -f "%Y-%m-%d" "$FILE_DATE" +%s 2>/dev/null)
          SEVEN_DAYS_AGO=$(date -d "7 days ago" +%s 2>/dev/null || date -v-7d +%s 2>/dev/null)
          
          if [ "$FILE_TIMESTAMP" -lt "$SEVEN_DAYS_AGO" ]; then
            echo "❌ Error: Latest newsletter ($NEWSLETTER_PATH) is more than 7 days old"
            echo "   Date in file: $FILE_DATE"
            echo "   This likely means the new newsletter hasn't been created yet."
            exit 1
          fi
          
          echo "newsletter_path=$NEWSLETTER_PATH" >> $GITHUB_OUTPUT
          echo "Found newsletter: $NEWSLETTER_PATH (dated $FILE_DATE)"
      
      - name: Extract newsletter content
        id: extract-content
        run: |
          FILE="${{ steps.find-newsletter.outputs.newsletter_path }}"
          
          # Extract title from frontmatter
          TITLE=$(grep -m1 "^title:" "$FILE" | sed "s/title:[[:space:]]*['\"]*//" | sed "s/['\"].*//")
          echo "Title: $TITLE"
          
          # Extract body (everything after the closing ---)
          # Skip frontmatter (between first and second ---) and get the rest
          BODY=$(awk '/^---$/{p++; next} p>=2' "$FILE")
          
          # Save to files to preserve formatting
          echo "$TITLE" > /tmp/newsletter_title.txt
          echo "$BODY" > /tmp/newsletter_body.md
          
          echo "Extracted $(wc -l < /tmp/newsletter_body.md) lines of content"
      
      - name: Send via Buttondown API
        env:
          BUTTONDOWN_API_KEY: ${{ secrets.BUTTONDOWN_API_KEY }}
        run: |
          TITLE=$(cat /tmp/newsletter_title.txt)
          BODY=$(cat /tmp/newsletter_body.md)
          
          # Convert relative links to absolute URLs
          BODY=$(echo "$BODY" | sed 's|](/|](https://nostrcompass.org/|g')
          
          # Create JSON payload (using jq for proper escaping)
          PAYLOAD=$(jq -n \
            --arg subject "$TITLE" \
            --arg body "$BODY" \
            '{subject: $subject, body: $body, status: "about_to_send"}')
          
          # Send to Buttondown
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST https://api.buttondown.com/v1/emails \
            -H "Authorization: Token $BUTTONDOWN_API_KEY" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n -1)
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Newsletter sent successfully!"
          else
            echo "❌ Failed to send newsletter (HTTP $HTTP_CODE)"
            echo "$RESPONSE_BODY"
            exit 1
          fi

