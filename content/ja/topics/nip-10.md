---
title: "NIP-10: テキストノートのスレッディング"
date: 2025-12-24
draft: false
categories:
  - Protocol
  - Social
---

NIP-10はkind 1ノートが返信スレッドを形成するためにお互いを参照する方法を規定しています。会話ビューを構築するにはこれを理解することが不可欠です。

## 問題

誰かがノートに返信するとき、クライアントは知る必要があります: これは何への返信か？会話のルートは何か？誰に通知すべきか？NIP-10は`e`タグ（イベント参照）と`p`タグ（pubkeyメンション）を通じてこれらの質問に答えます。

## マーク付きタグ（推奨）

現代のクライアントは`e`タグで明示的なマーカーを使用します:

```json
{
  "id": "f9c2e...",
  "pubkey": "a3b9c...",
  "created_at": 1734912345,
  "kind": 1,
  "tags": [
    ["e", "abc123...", "wss://relay.example.com", "root"],
    ["e", "def456...", "wss://relay.example.com", "reply"],
    ["p", "91cf9..."],
    ["p", "14aeb..."]
  ],
  "content": "素晴らしいポイント！同意します。",
  "sig": "b7d3f..."
}
```

`root`マーカーはスレッドを開始した元のノートを指します。`reply`マーカーは回答している特定のノートを指します。ルートに直接返信する場合は、`root`のみを使用します（`reply`タグは不要）。この区別はレンダリングに重要です: `reply`はスレッドビューでのインデントを決定し、`root`はすべての返信をグループ化します。

## スレッディングルール

- **ルートへの直接返信:** `root`マーカー付きの1つの`e`タグ
- **返信への返信:** 2つの`e`タグ、1つは`root`、1つは`reply`
- `root`はスレッド全体で一定のまま。`reply`は返信先に応じて変わる

## 通知用のPubkeyタグ

通知されるべき全員の`p`タグを含めます。最低限、返信しているノートの作成者をタグ付けします。慣例として、親イベントからのすべての`p`タグも含めます（会話の全員がループに留まるように）、さらにコンテンツで@メンションしたユーザーも含めます。

## リレーヒント

`e`および`p`タグの3番目の位置には、そのイベントまたはユーザーのコンテンツが見つかる可能性のあるリレーURLを含めることができます。これにより、クライアントは元のリレーに接続していなくても参照されているコンテンツを取得できます。

## 非推奨の位置タグ

初期のNostr実装では、マーカーではなくタグの位置から意味を推論していました: 最初の`e`タグがルート、最後がリプライ、中間がメンション。このアプローチは曖昧さを生むため非推奨です。マーカーのない`e`タグを見た場合、おそらく古いクライアントからのものです。現代の実装は常に明示的なマーカーを使用すべきです。

## スレッドビューの構築

スレッドを表示するには、ルートイベントを取得し、そのルートを参照する`e`タグを持つすべてのイベントをクエリします:

```json
["REQ", "thread", {"kinds": [1], "#e": ["<root-event-id>"]}]
```

結果を`created_at`でソートし、`reply`マーカーを使用してツリー構造を構築します。`reply`がルートを指すイベントはトップレベルの返信です。`reply`が別の返信を指すイベントはネストされた応答です。

---

**主要ソース:**
- [NIP-10仕様](https://github.com/nostr-protocol/nips/blob/master/10.md)

**言及箇所:**
- [ニュースレター #2: NIP詳細解説](/ja/newsletters/2025-12-24-newsletter/#nip-10-text-note-threading)

**関連項目:**
- [NIP-01: 基本プロトコル](/ja/topics/nip-01/)

